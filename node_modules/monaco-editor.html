<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <style>
        .styleDark {
            background-color:black;
            color: rgb(226, 226, 226);
        }
        .stylBright {
            background-color:white;
            color: rgb(32, 32, 32);
        }
    </style>
</head>

<body style="background-color:black;">
    <input class="styleDark" type="text" id="fileName" placeholder="Script URL" style="height: 17px;width:100%;border:1px solid grey">
    <button class="styleDark" onclick="loadScript()" id="myButtonA" style="position:absolute;top: 1.1%;left: 93%;">Load
        Script</button>
    <div id="container" style="width:100%;height: 650px;border:1px solid grey"></div>
    <button class="styleDark" id="saveJsButton" onclick="saveJs()">Save</button>
    <input id="goLiveCheckbox" type="checkbox" onclick="goLine()">
    <label for="goLiveCheckbox" style="color: rgb(226, 226, 226);">Go Live</label>
    <p id="changeStyleButton" onclick="changeStyle()" style="position:absolute;top: 654px;left: 96%;font-size: 28px;">ðŸŒœ</p>
    <script src="monaco-editor/min/vs/loader.js"></script>
    <script>
        var id = Date.now();
        var importedScript;
        var editor;
        var isLive = false;
        var pawsUpdate = false;
        var myTimeout;
        var styleDark = true;
        require.config({ paths: { 'vs': 'monaco-editor/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('container'), {
                value: [
                ].join('\n'),
                language: "javascript",
                theme: "vs-dark"
            });
            editor.onDidChangeModelContent(function (evt) {
                if (isLive) {
                    sendLiveUpdates();
                }
            });
        });

        var dataBeingSent = false;

        function saveJs() {
            if (!dataBeingSent) {
                dataBeingSent = true;
                getVal = editor.getValue()
                console.log(getVal);
                var fileName = document.getElementById("fileName").value;
                if (fileName == "") {
                    alert("Script URL Empty");
                } else {
                    var messageData = {
                        action: "save",
                        fileName: document.getElementById("fileName").value,
                        fileData: getVal
                    };
                    EventBridge.emitWebEvent(JSON.stringify(messageData));
                    alert(document.getElementById("fileName").value + " Saved");
                    dataBeingSent = false;
                }
            }
        }

        function loadScript() {
            if (isLive) {
                document.getElementById("goLiveCheckbox").checked = false;
                goLine();
            }
            var fileName = document.getElementById("fileName").value;
            if (fileName == "") {
                alert("Script URL Empty");
            }
            var messageData = {
                action: "loadScript",
                fileName: fileName
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

        EventBridge.scriptEventReceived.connect(function (message) {
            var messageData = JSON.parse(message);
            if (messageData.action == "loadScriptResponse") {
                importedScript = messageData.fileData
                window.editor.getModel().setValue(importedScript);
            } else if (messageData.action == "receiveLiveData") {
                if (pawsUpdate) {
                    clearTimeout(myTimeout);
                }
                pawsUpdate = true;
                myTimeout = setTimeout(() => {
                    pawsUpdate = false;
                }, 500);
                importedScript = messageData.fileData
                window.editor.getModel().setValue(importedScript);
            }
        });

        function goLine() {
            if (!isLive) {
                isLive = true;
                var messageData = {
                    action: "goLive",
                    id: id,
                    fileName: document.getElementById("fileName").value
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            } else {
                isLive = false;
                var messageData = {
                    action: "goSilent",
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            }
        }

        function sendLiveUpdates() {
            if (!pawsUpdate) {
                var messageData = {
                    action: "sendLiveUpdates",
                    id: id,
                    fileName: document.getElementById("fileName").value,
                    scriptUpdateData: getVal = editor.getValue()
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            }
        }

        function changeStyle() {
            if (styleDark) {
                styleDark = false;
                document.getElementById("changeStyleButton").innerHTML = "ðŸŒž";
                document.getElementById("fileName").className = "stylBright";
                document.getElementById("myButtonA").className = "stylBright";
                document.getElementById("saveJsButton").className = "stylBright";
                document.body.style.backgroundColor = "rgb(195, 195, 195)";
                monaco.editor.setTheme('vs');
            } else {
                styleDark = true;
                document.getElementById("changeStyleButton").innerHTML = "ðŸŒœ";
                document.getElementById("fileName").className = "styleDark";
                document.getElementById("myButtonA").className = "styleDark";
                document.getElementById("saveJsButton").className = "styleDark";
                document.body.style.backgroundColor = "black";
                monaco.editor.setTheme('vs-dark');
            }
        }

    </script>

</body>

</html>