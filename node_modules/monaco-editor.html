<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" href="editorStyle.css">
</head>

<body style="background-color:black;" onload="requestCurrentPageStatus()">
    <input class="styleDark" type="text" id="fileName" placeholder="Script URL">
    <button class="styleDark" onclick="loadScript()" id="myButtonA">Load Script</button>
    <div id="container"></div>
    <button class="styleDark" id="saveJsButton" onclick="saveJs()">Save</button>
    <button class="styleDark" id="executeButton" onclick="executeJs()">Execute</button>
    <svg onclick="openTabletEditorMenu()" id="listSvg" viewBox="0 0 24 24">
        <image xlink:href="view_list.svg" width="24px" height="24px" />
    </svg>
    <input id="goLiveCheckbox" type="checkbox" onclick="goLine()">
    <label for="goLiveCheckbox" id="goLiveCheckboxLabel">Go Live</label>
    <svg onclick="pickerGetScript()" id="pickerSvg" viewBox="0 0 24 24">
        <image xlink:href="eyedropper.svg" width="24px" height="24px" />
    </svg>
    <input id="entityScriptCheckbox" checked=true; type="checkbox" onclick="chooseScriptType('script')">
    <label for="entityScriptCheckbox" id="entityScriptCheckboxLabel">Entity Script</label>
    <input id="serverScriptCheckbox" type="checkbox" onclick="chooseScriptType('serverScripts')">
    <label for="serverScriptCheckbox" id="serverScriptCheckboxLabel">Server Script</label>
    <p id="changeStyleButton" onclick="changeStyle()">ðŸŒœ</p>
    <script src="monaco-editor/min/vs/loader.js"></script>
    <script>
        var id = Date.now();
        var importedScript;
        var editor;
        var isLive = false;
        var pawsUpdate = false;
        var myTimeout;
        var styleDark = true;
        var scriptType = "script";
        var defaultScriptTemplate = "(function () {\n    this.clickDownOnEntity = function () {\n        entityTiggered();\n    }\n    \n    this.startNearTrigger = function () {\n        entityTiggered();\n    };\n    \n    this.startFarTrigger = function () {\n        entityTiggered();\n    };\n    \n    function entityTiggered() {\n    }\n    \n    this.unload = function () {\n    }\n});\n";
        require.config({ paths: { 'vs': 'monaco-editor/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById("container"), {
                value: defaultScriptTemplate,
                language: "javascript",
                theme: "vs-dark"
            });

            function ShowAutocompletion(obj) {
                function getType(thing, isMember) {
                    isMember = (isMember == undefined) ? (typeof isMember == "boolean") ? isMember : false : false;

                    switch ((typeof thing).toLowerCase()) {
                        case "object":
                            return monaco.languages.CompletionItemKind.Class;

                        case "function":
                            return (isMember) ? monaco.languages.CompletionItemKind.Method : monaco.languages.CompletionItemKind.Function;

                        default:
                            return (isMember) ? monaco.languages.CompletionItemKind.Property : monaco.languages.CompletionItemKind.Variable;
                    }
                }

                monaco.languages.registerCompletionItemProvider('javascript', {
                    triggerCharacters: ['.', '('],

                    provideCompletionItems: function (model, position, token) {
                        var last_chars = model.getValueInRange({ startLineNumber: position.lineNumber, startColumn: 0, endLineNumber: position.lineNumber, endColumn: position.column });
                        var words = last_chars.replace("\t", "").split(" ");
                        var active_typing = words[words.length - 1];

                        var is_member = active_typing.charAt(active_typing.length - 1) == ".";

                        var result = [];

                        var last_token = obj;
                        var prefix = '';

                        if (is_member) {
                            var parents = active_typing.substring(0, active_typing.length - 1).split(".");
                            last_token = obj[parents[0]];
                            prefix = parents[0];

                            for (var i = 1; i < parents.length; i++) {
                                if (last_token.hasOwnProperty(parents[i])) {
                                    prefix += '.' + parents[i];
                                    last_token = last_token[parents[i]];
                                } else {
                                    return result;
                                }
                            }

                            prefix += '.';
                        }

                        for (var prop in last_token) {

                            if (last_token.hasOwnProperty(prop) && !prop.startsWith("__")) {

                                var details = '';
                                try {
                                    details = last_token[prop].__proto__.constructor.name;
                                } catch (e) {
                                    details = typeof last_token[prop];
                                }

                                var to_push = {
                                    label: prefix + prop,
                                    kind: getType(last_token[prop], is_member),
                                    detail: details,
                                    insertText: prop
                                };

                                if (to_push.detail.toLowerCase() == 'function') {
                                    to_push.insertText += "(";
                                    to_push.documentation = (last_token[prop].toString()).split("{")[0];
                                }

                                result.push(to_push);
                            }
                        }

                        return {
                            suggestions: result
                        };
                    }
                });
            }

            ShowAutocompletion({
                Entities: {
                    addEntity: "",
                    editEntity: "",
                    deleteEntity: "",
                    getEntityProperties: {}
                },
                MyAvatar: {
                    position: ""
                },
                Script: {
                    addEventHandler: "",
                    clearInterval: "",
                    clearTimeout: "",
                    setInterval: "",
                    setTimeout: ""
                },
                Settings: {
                    getValue: "",
                    setValue: ""
                },
                this: {
                    clickDownOnEntity: "",
                    enterEntity: "",
                    preload: "",
                    startFarTrigger: "",
                    startNearTrigger: "",
                    leaveEntity: "",
                    unload: ""
                },
                Window: {
                    alert: "",
                    prompt: ""
                },
                angularDamping: 0,
                avatar: "",
                type: "",
                dimensions: {},
                position: {},
                rotation: {},
                script: "",
                serverScripts: "",
                color: {}
            });

            editor.onDidChangeModelContent(function (evt) {
                if (isLive) {
                    sendLiveUpdates();
                } else if (!isLive) {
                    updatePageData();
                }
            });
        });

        var dataBeingSent = false;

        function saveJs() {
            if (!dataBeingSent) {
                dataBeingSent = true;
                getVal = editor.getValue()
                var fileName = document.getElementById("fileName").value;
                if (fileName == "") {
                    alert("Script URL Empty");
                } else if (fileName.split(":")[0] == "ws") {
                    var ws = new WebSocket("ws://localhost:888");
                    ws.onopen = function () {
                        var a = {
                            action: "saveFile",
                            fileName: fileName.split("/")[3],
                            fileData: getVal
                        }
                        ws.send(JSON.stringify(a));
                        ws.close();
                    }
                    ws.onclose = function () {
                        dataBeingSent = false;
                        alert(fileName.split("/")[3] + " Saved");
                    }
                } else {
                    var messageData = {
                        action: "save",
                        fileName: document.getElementById("fileName").value,
                        fileData: getVal
                    };
                    EventBridge.emitWebEvent(JSON.stringify(messageData));
                    alert(document.getElementById("fileName").value + " Saved");
                    dataBeingSent = false;
                }
            }
        }

        function loadScript() {
            if (isLive) {
                document.getElementById("goLiveCheckbox").checked = false;
                goLine();
            }
            var fileName = document.getElementById("fileName").value;
            if (fileName == "") {
                alert("Script URL Empty");
            } else if (fileName.split(":")[0] == "ws") {
                var ws = new WebSocket("ws://localhost:888");
                ws.onopen = function () {
                    ws.send(JSON.stringify({
                        action: "requestFile",
                        fileName: fileName.split("/")[3]
                    }));
                    ws.send(JSON.stringify(a));
                }
                ws.onclose = function () {
                    dataBeingSent = false;
                }
                ws.onmessage = function (evt) {
                    var evtData = JSON.parse(evt.data);
                    if (evtData.action = "requestFileResponse") {
                        if (evtData.file == "File Not Found") {
                            alert(fileName.split("/")[3] + " File Not Found");
                            ws.close();
                        } else {
                            importedScript = evtData.file;
                            window.editor.getModel().setValue(importedScript);
                            ws.close();
                        }
                    }
                }
            } else if (fileName.split(":")[0] == "http") {
                alert("http Not Yet Supported");
            } else {
                var messageData = {
                    action: "loadScript",
                    fileName: fileName
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            }
        }

        EventBridge.scriptEventReceived.connect(function (message) {
            var messageData = JSON.parse(message);
            if (messageData.action == "loadScriptResponse") {
                importedScript = messageData.fileData
                window.editor.getModel().setValue(importedScript);
                if (messageData.fileName != undefined) {
                    document.getElementById("fileName").value = messageData.fileName;
                }
            } else if (messageData.action == "receiveLiveData") {
                if (pawsUpdate) {
                    clearTimeout(myTimeout);
                }
                pawsUpdate = true;
                myTimeout = setTimeout(() => {
                    pawsUpdate = false;
                }, 500);
                importedScript = messageData.fileData;
                window.editor.getModel().setValue(importedScript);
            } else if (messageData.action == "requestCurrentPageStatusResponse") {
                if (messageData.pageStatus.scriptData != "") {
                    importedScript = messageData.pageStatus.scriptData;
                    window.editor.getModel().setValue(importedScript);
                }
                if (!messageData.pageStatus.styleDark) {
                    changeStyle();
                }
            } else if (messageData.action == "editFile") {
                importedScript = messageData.fileData;
                window.editor.getModel().setValue(importedScript);
                document.getElementById("fileName").value = "ws://localhost/" + messageData.fileName
            }
        });

        function goLine() {
            if (!isLive) {
                isLive = true;
                var messageData = {
                    action: "goLive",
                    id: id,
                    fileName: document.getElementById("fileName").value
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            } else {
                isLive = false;
                var messageData = {
                    action: "goSilent",
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            }
        }

        function sendLiveUpdates() {
            if (!pawsUpdate) {
                var messageData = {
                    action: "sendLiveUpdates",
                    id: id,
                    fileName: document.getElementById("fileName").value,
                    scriptUpdateData: editor.getValue()
                };
                EventBridge.emitWebEvent(JSON.stringify(messageData));
            }
        }

        function executeJs() {
            var messageData = {
                action: "executeJs",
                id: id,
                scriptData: editor.getValue()
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

        function requestCurrentPageStatus() {
            var messageData = {
                action: "requestCurrentPageStatus"
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

        function updatePageData() {
            var messageData = {
                action: "updatePageData",
                scriptData: editor.getValue()
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

        function changeStyle() {
            if (styleDark) {
                styleDark = false;
                document.getElementById("changeStyleButton").innerHTML = "ðŸŒž";
                document.getElementById("fileName").className = "stylBright";
                document.getElementById("myButtonA").className = "stylBright";
                document.getElementById("saveJsButton").className = "stylBright";
                document.getElementById("executeButton").className = "stylBright";
                document.body.style.backgroundColor = "rgb(195, 195, 195)";
                monaco.editor.setTheme('vs');
            } else {
                styleDark = true;
                document.getElementById("changeStyleButton").innerHTML = "ðŸŒœ";
                document.getElementById("fileName").className = "styleDark";
                document.getElementById("myButtonA").className = "styleDark";
                document.getElementById("saveJsButton").className = "styleDark";
                document.getElementById("executeButton").className = "styleDark";
                document.body.style.backgroundColor = "black";
                monaco.editor.setTheme('vs-dark');
            }
            var messageData = {
                action: "updateStyle",
                styleDark: styleDark
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

        function chooseScriptType(onclickScriptType) {
            scriptType = onclickScriptType;
            if (scriptType == "script") {
                document.getElementById("serverScriptCheckbox").checked = false;
                document.getElementById("entityScriptCheckbox").checked = true;
            } else {
                document.getElementById("entityScriptCheckbox").checked = false;
                document.getElementById("serverScriptCheckbox").checked = true;
            }
        }

        function pickerGetScript() {
            if (isLive) {
                document.getElementById("goLiveCheckbox").checked = false;
                goLine();
            }
            var messageData = {
                action: "pickerGetScript",
                scriptType: scriptType
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

        function openTabletEditorMenu() {
            var messageData = {
                action: "openTabletEditorMenu"
            };
            EventBridge.emitWebEvent(JSON.stringify(messageData));
        }

    </script>

</body>

</html>